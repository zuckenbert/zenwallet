# ZenWallet MVP 1.2.0 - Production Ready

> Final push para 100% production ready: PWA, Security, Error Handling, Optimization

**Reference:** `/Users/lucasbertol/zenwallet/MASTERPLAN.md`
**Previous:** MVP 1.1.0 (Core Wallet Features)

---

## Metadata

| Campo | Valor |
|-------|-------|
| **Projeto** | ZenWallet - Crypto Wallet Gamificada |
| **Versao** | MVP 1.2.0 |
| **Stack** | React 19 + TypeScript + Tailwind + Solana + PWA |
| **Data** | 2025-12-26 |
| **Status Atual** | ~55% production ready |
| **Target** | 95%+ production ready |

---

## Architecture Overview

```
MVP 1.2.0 Changes:
├── vite.config.ts              # [UPDATE] PWA plugin + code splitting
├── public/
│   ├── icons/
│   │   ├── icon-192.png        # [NEW] PWA icon
│   │   └── icon-512.png        # [NEW] PWA icon
│   └── manifest.json           # [UPDATE] Already exists
├── src/
│   ├── main.tsx                # [UPDATE] Error boundary wrapper
│   ├── App.tsx                 # [UPDATE] Session timeout, network status
│   ├── components/
│   │   ├── ui/
│   │   │   ├── Toast.tsx       # [NEW] Toast notifications
│   │   │   ├── ErrorBoundary.tsx # [NEW] Error boundary
│   │   │   ├── NetworkStatus.tsx # [NEW] Online/offline indicator
│   │   │   └── Skeleton.tsx    # [NEW] Loading skeletons
│   │   └── modals/
│   │       ├── DisclaimerModal.tsx # [NEW] Legal disclaimers
│   │       └── InstallPrompt.tsx   # [NEW] PWA install prompt
│   ├── stores/
│   │   ├── walletStore.ts      # [UPDATE] Rate limiting, session timeout
│   │   ├── securityStore.ts    # [NEW] Security state management
│   │   └── toastStore.ts       # [NEW] Toast state
│   ├── hooks/
│   │   ├── useSessionTimeout.ts # [NEW] Auto-lock after inactivity
│   │   ├── useNetworkStatus.ts  # [NEW] Online/offline detection
│   │   ├── useClipboard.ts      # [NEW] Secure clipboard with auto-clear
│   │   └── usePWAInstall.ts     # [NEW] PWA install prompt
│   └── lib/
│       └── security/
│           └── rateLimiter.ts  # [NEW] PIN rate limiting
└── tests/                      # [NEW] Test suite
    ├── setup.ts
    ├── crypto/
    │   ├── encryption.test.ts
    │   └── bip39.test.ts
    └── gamification/
        └── xp.test.ts
```

---

## Sprint Overview

| Batch | Focus | Tasks | Priority |
|-------|-------|-------|----------|
| 5.1 | PWA Setup | 4 tasks | CRITICAL |
| 5.2 | Security - Rate Limiting | 3 tasks | CRITICAL |
| 5.3 | Security - Session Timeout | 2 tasks | CRITICAL |
| 5.4 | Error Handling | 4 tasks | HIGH |
| 5.5 | Toast System | 2 tasks | HIGH |
| 5.6 | UX Polish | 3 tasks | MEDIUM |
| 5.7 | Build Optimization | 2 tasks | HIGH |
| 5.8 | Testing Setup | 3 tasks | MEDIUM |

---

## Batch 5.1: PWA Complete Setup

### Task 5.1.1: Install PWA Dependencies

**Command:**
```bash
cd /Users/lucasbertol/zenwallet && npm install vite-plugin-pwa workbox-window
```

**Verification:**
```bash
npm list vite-plugin-pwa
# Should show vite-plugin-pwa@0.x.x
```

---

### Task 5.1.2: Update Vite Config for PWA

**File:** `vite.config.ts`

**Code:**
```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import { VitePWA } from 'vite-plugin-pwa';
import path from 'path';

export default defineConfig({
  plugins: [
    react(),
    VitePWA({
      registerType: 'autoUpdate',
      includeAssets: ['icons/*.png', 'icons/*.svg'],
      manifest: {
        name: 'ZenWallet',
        short_name: 'ZenWallet',
        description: 'Crypto wallet gamificada para jovens',
        theme_color: '#0A0A0B',
        background_color: '#0A0A0B',
        display: 'standalone',
        scope: '/',
        start_url: '/',
        orientation: 'portrait',
        icons: [
          {
            src: '/icons/icon-192.png',
            sizes: '192x192',
            type: 'image/png',
          },
          {
            src: '/icons/icon-512.png',
            sizes: '512x512',
            type: 'image/png',
          },
          {
            src: '/icons/icon-512.png',
            sizes: '512x512',
            type: 'image/png',
            purpose: 'maskable',
          },
        ],
      },
      workbox: {
        globPatterns: ['**/*.{js,css,html,ico,png,svg,woff2}'],
        runtimeCaching: [
          {
            urlPattern: /^https:\/\/(mainnet|devnet)\.helius-rpc\.com/,
            handler: 'NetworkFirst',
            options: {
              cacheName: 'rpc-cache',
              expiration: {
                maxEntries: 50,
                maxAgeSeconds: 300, // 5 minutes
              },
              networkTimeoutSeconds: 10,
            },
          },
          {
            urlPattern: /^https:\/\/price\.jup\.ag/,
            handler: 'NetworkFirst',
            options: {
              cacheName: 'price-cache',
              expiration: {
                maxEntries: 100,
                maxAgeSeconds: 60, // 1 minute
              },
            },
          },
          {
            urlPattern: /^https:\/\/quote-api\.jup\.ag/,
            handler: 'NetworkOnly',
          },
          {
            urlPattern: /^https:\/\/raw\.githubusercontent\.com.*token-list/,
            handler: 'CacheFirst',
            options: {
              cacheName: 'token-logos',
              expiration: {
                maxEntries: 200,
                maxAgeSeconds: 86400, // 24 hours
              },
            },
          },
        ],
      },
    }),
  ],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
  define: {
    'process.env': {},
    global: 'globalThis',
  },
  optimizeDeps: {
    esbuildOptions: {
      define: {
        global: 'globalThis',
      },
    },
  },
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          'solana': ['@solana/web3.js', '@solana/spl-token'],
          'wallet-adapter': [
            '@solana/wallet-adapter-base',
            '@solana/wallet-adapter-react',
            '@solana/wallet-adapter-wallets',
          ],
          'jupiter': ['@jup-ag/api'],
          'ui': ['framer-motion', 'qrcode.react'],
        },
      },
    },
  },
});
```

**Verification:**
```bash
npm run build
# Should show multiple chunks instead of one large chunk
# Each chunk should be < 500KB
```

---

### Task 5.1.3: Create PWA Icons

**File:** `public/icons/icon-192.png` and `public/icons/icon-512.png`

Since we need actual PNG files, create a simple script to generate placeholder icons:

**File:** `scripts/generate-icons.js`

```javascript
// Run with: node scripts/generate-icons.js
const fs = require('fs');
const path = require('path');

// Create a simple SVG that can be converted to PNG
const svgContent = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
  <rect width="512" height="512" fill="#0A0A0B"/>
  <circle cx="256" cy="256" r="180" fill="none" stroke="#14F195" stroke-width="24"/>
  <text x="256" y="290" font-family="Arial" font-size="180" font-weight="bold" fill="#14F195" text-anchor="middle">Z</text>
</svg>`;

const iconsDir = path.join(__dirname, '..', 'public', 'icons');

// Ensure directory exists
if (!fs.existsSync(iconsDir)) {
  fs.mkdirSync(iconsDir, { recursive: true });
}

// Save SVG (can be used directly or converted to PNG)
fs.writeFileSync(path.join(iconsDir, 'icon.svg'), svgContent);
console.log('Icon SVG created at public/icons/icon.svg');
console.log('For production, convert to PNG using: https://convertio.co/svg-png/');
```

For now, let's create a base64 PNG placeholder:

**Command:**
```bash
mkdir -p /Users/lucasbertol/zenwallet/public/icons
```

**Note:** Use an online tool or design software to create proper 192x192 and 512x512 PNG icons. For development, the SVG will work.

---

### Task 5.1.4: Create PWA Install Prompt Hook

**File:** `src/hooks/usePWAInstall.ts`

**Code:**
```typescript
import { useState, useEffect, useCallback } from 'react';

interface BeforeInstallPromptEvent extends Event {
  prompt: () => Promise<void>;
  userChoice: Promise<{ outcome: 'accepted' | 'dismissed' }>;
}

export function usePWAInstall() {
  const [deferredPrompt, setDeferredPrompt] = useState<BeforeInstallPromptEvent | null>(null);
  const [isInstallable, setIsInstallable] = useState(false);
  const [isInstalled, setIsInstalled] = useState(false);

  useEffect(() => {
    // Check if already installed
    if (window.matchMedia('(display-mode: standalone)').matches) {
      setIsInstalled(true);
      return;
    }

    const handleBeforeInstall = (e: Event) => {
      e.preventDefault();
      setDeferredPrompt(e as BeforeInstallPromptEvent);
      setIsInstallable(true);
    };

    const handleAppInstalled = () => {
      setIsInstalled(true);
      setIsInstallable(false);
      setDeferredPrompt(null);
    };

    window.addEventListener('beforeinstallprompt', handleBeforeInstall);
    window.addEventListener('appinstalled', handleAppInstalled);

    return () => {
      window.removeEventListener('beforeinstallprompt', handleBeforeInstall);
      window.removeEventListener('appinstalled', handleAppInstalled);
    };
  }, []);

  const install = useCallback(async () => {
    if (!deferredPrompt) return false;

    try {
      await deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;

      if (outcome === 'accepted') {
        setIsInstalled(true);
        setIsInstallable(false);
      }

      setDeferredPrompt(null);
      return outcome === 'accepted';
    } catch {
      return false;
    }
  }, [deferredPrompt]);

  return { isInstallable, isInstalled, install };
}
```

**Verification:**
```typescript
// In any component:
const { isInstallable, install } = usePWAInstall();
// On mobile Chrome, isInstallable should be true
```

---

## Batch 5.2: Security - Rate Limiting

### Task 5.2.1: Create Rate Limiter Utility

**File:** `src/lib/security/rateLimiter.ts`

**Code:**
```typescript
const STORAGE_KEY = 'zenwallet-pin-attempts';
const MAX_ATTEMPTS = 5;
const LOCKOUT_DURATION_MS = 30 * 60 * 1000; // 30 minutes

interface AttemptData {
  count: number;
  firstAttempt: number;
  lockedUntil: number | null;
}

function getAttemptData(): AttemptData {
  const stored = localStorage.getItem(STORAGE_KEY);
  if (!stored) {
    return { count: 0, firstAttempt: 0, lockedUntil: null };
  }
  return JSON.parse(stored);
}

function setAttemptData(data: AttemptData): void {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

export function isLocked(): { locked: boolean; remainingMs: number } {
  const data = getAttemptData();

  if (data.lockedUntil) {
    const remaining = data.lockedUntil - Date.now();
    if (remaining > 0) {
      return { locked: true, remainingMs: remaining };
    }
    // Lockout expired, reset
    setAttemptData({ count: 0, firstAttempt: 0, lockedUntil: null });
  }

  return { locked: false, remainingMs: 0 };
}

export function recordFailedAttempt(): { locked: boolean; attemptsRemaining: number; lockoutMs: number } {
  const data = getAttemptData();
  const now = Date.now();

  // Reset if first attempt was more than lockout duration ago
  if (data.firstAttempt && now - data.firstAttempt > LOCKOUT_DURATION_MS) {
    data.count = 0;
    data.firstAttempt = 0;
  }

  // Record this attempt
  data.count += 1;
  if (data.count === 1) {
    data.firstAttempt = now;
  }

  // Check if should lock
  if (data.count >= MAX_ATTEMPTS) {
    data.lockedUntil = now + LOCKOUT_DURATION_MS;
    setAttemptData(data);
    return { locked: true, attemptsRemaining: 0, lockoutMs: LOCKOUT_DURATION_MS };
  }

  setAttemptData(data);
  return {
    locked: false,
    attemptsRemaining: MAX_ATTEMPTS - data.count,
    lockoutMs: 0,
  };
}

export function resetAttempts(): void {
  localStorage.removeItem(STORAGE_KEY);
}

export function formatLockoutTime(ms: number): string {
  const minutes = Math.ceil(ms / 60000);
  if (minutes >= 60) {
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    return `${hours}h ${mins}m`;
  }
  return `${minutes} minute${minutes !== 1 ? 's' : ''}`;
}
```

**Verification:**
```typescript
import { recordFailedAttempt, isLocked, resetAttempts } from '@/lib/security/rateLimiter';

// Test:
for (let i = 0; i < 5; i++) {
  const result = recordFailedAttempt();
  console.log(`Attempt ${i + 1}:`, result);
}
// After 5 attempts, should show locked: true

resetAttempts(); // Clean up
```

---

### Task 5.2.2: Create Security Store

**File:** `src/stores/securityStore.ts`

**Code:**
```typescript
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface SecurityState {
  // Disclaimer acceptance
  disclaimerAccepted: boolean;
  disclaimerAcceptedAt: string | null;

  // Session tracking
  lastActivity: number;
  sessionTimeoutMs: number;

  // Actions
  acceptDisclaimer: () => void;
  updateActivity: () => void;
  setSessionTimeout: (ms: number) => void;
  isSessionExpired: () => boolean;
}

const DEFAULT_SESSION_TIMEOUT = 5 * 60 * 1000; // 5 minutes

export const useSecurityStore = create<SecurityState>()(
  persist(
    (set, get) => ({
      disclaimerAccepted: false,
      disclaimerAcceptedAt: null,
      lastActivity: Date.now(),
      sessionTimeoutMs: DEFAULT_SESSION_TIMEOUT,

      acceptDisclaimer: () => {
        set({
          disclaimerAccepted: true,
          disclaimerAcceptedAt: new Date().toISOString(),
        });
      },

      updateActivity: () => {
        set({ lastActivity: Date.now() });
      },

      setSessionTimeout: (ms: number) => {
        set({ sessionTimeoutMs: ms });
      },

      isSessionExpired: () => {
        const { lastActivity, sessionTimeoutMs } = get();
        return Date.now() - lastActivity > sessionTimeoutMs;
      },
    }),
    {
      name: 'zenwallet-security',
      partialize: (state) => ({
        disclaimerAccepted: state.disclaimerAccepted,
        disclaimerAcceptedAt: state.disclaimerAcceptedAt,
        sessionTimeoutMs: state.sessionTimeoutMs,
      }),
    }
  )
);
```

**Verification:**
```typescript
// In console:
import { useSecurityStore } from '@/stores/securityStore';
const store = useSecurityStore.getState();
console.log(store.disclaimerAccepted); // false initially
store.acceptDisclaimer();
console.log(store.disclaimerAccepted); // true
```

---

### Task 5.2.3: Update WalletStore with Rate Limiting

**File:** `src/stores/walletStore.ts`

**Changes:** Update the `unlockWallet` function to include rate limiting.

**Code to add after imports:**
```typescript
import { isLocked, recordFailedAttempt, resetAttempts, formatLockoutTime } from '@/lib/security/rateLimiter';
```

**Replace the `unlockWallet` function:**
```typescript
      unlockWallet: async (pin: string) => {
        const { publicKey } = get();
        if (!publicKey) throw new Error('No wallet to unlock');

        // Check rate limiting
        const lockStatus = isLocked();
        if (lockStatus.locked) {
          const timeRemaining = formatLockoutTime(lockStatus.remainingMs);
          set({ error: `Too many attempts. Try again in ${timeRemaining}`, isLoading: false });
          throw new Error(`Locked for ${timeRemaining}`);
        }

        set({ isLoading: true, error: null });

        try {
          const stored = await getWallet(publicKey);
          if (!stored) throw new Error('Wallet not found');

          const key = await deriveKey(pin, stored.salt);
          const decrypted = await decrypt(stored.encryptedSecretKey, key);

          const keypair = Keypair.fromSecretKey(decrypted);

          // Verify public key matches
          if (keypair.publicKey.toBase58() !== publicKey) {
            throw new Error('Invalid PIN');
          }

          // Success - reset attempts
          resetAttempts();

          set({
            isUnlocked: true,
            _keypair: keypair,
            isLoading: false,
          });
        } catch {
          // Record failed attempt
          const result = recordFailedAttempt();

          let errorMessage = 'Invalid PIN';
          if (result.locked) {
            errorMessage = `Too many attempts. Locked for ${formatLockoutTime(result.lockoutMs)}`;
          } else if (result.attemptsRemaining <= 2) {
            errorMessage = `Invalid PIN. ${result.attemptsRemaining} attempts remaining`;
          }

          set({ error: errorMessage, isLoading: false });
          throw new Error(errorMessage);
        }
      },
```

**Verification:**
- Try unlocking with wrong PIN 5 times
- Should show lockout message after 5 attempts
- After correct PIN, attempts should reset

---

## Batch 5.3: Security - Session Timeout

### Task 5.3.1: Create Session Timeout Hook

**File:** `src/hooks/useSessionTimeout.ts`

**Code:**
```typescript
import { useEffect, useCallback, useRef } from 'react';
import { useWalletStore } from '@/stores/walletStore';
import { useSecurityStore } from '@/stores/securityStore';

const ACTIVITY_EVENTS = [
  'mousedown',
  'mousemove',
  'keydown',
  'scroll',
  'touchstart',
  'click',
];

export function useSessionTimeout() {
  const { isUnlocked, lockWallet, walletType } = useWalletStore();
  const { sessionTimeoutMs, updateActivity, isSessionExpired } = useSecurityStore();
  const timeoutRef = useRef<NodeJS.Timeout | null>(null);

  const handleActivity = useCallback(() => {
    updateActivity();

    // Reset timeout
    if (timeoutRef.current) {
      clearTimeout(timeoutRef.current);
    }

    if (isUnlocked && walletType === 'internal') {
      timeoutRef.current = setTimeout(() => {
        if (isSessionExpired()) {
          lockWallet();
        }
      }, sessionTimeoutMs);
    }
  }, [isUnlocked, walletType, sessionTimeoutMs, updateActivity, isSessionExpired, lockWallet]);

  useEffect(() => {
    // Only track for internal wallets (not external like Phantom)
    if (!isUnlocked || walletType !== 'internal') {
      return;
    }

    // Initial activity update
    handleActivity();

    // Add event listeners
    ACTIVITY_EVENTS.forEach((event) => {
      window.addEventListener(event, handleActivity, { passive: true });
    });

    // Check on visibility change (tab switch)
    const handleVisibilityChange = () => {
      if (document.visibilityState === 'visible') {
        if (isSessionExpired()) {
          lockWallet();
        } else {
          handleActivity();
        }
      }
    };
    document.addEventListener('visibilitychange', handleVisibilityChange);

    return () => {
      ACTIVITY_EVENTS.forEach((event) => {
        window.removeEventListener(event, handleActivity);
      });
      document.removeEventListener('visibilitychange', handleVisibilityChange);

      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current);
      }
    };
  }, [isUnlocked, walletType, handleActivity, isSessionExpired, lockWallet]);
}
```

**Verification:**
- Set session timeout to 10 seconds for testing
- After 10 seconds of inactivity, wallet should auto-lock
- Any mouse/keyboard activity should reset the timer

---

### Task 5.3.2: Create Disclaimer Modal

**File:** `src/components/modals/DisclaimerModal.tsx`

**Code:**
```typescript
import { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Button } from '@/components/ui/Button';
import { useSecurityStore } from '@/stores/securityStore';

export function DisclaimerModal() {
  const { disclaimerAccepted, acceptDisclaimer } = useSecurityStore();
  const [checked, setChecked] = useState(false);

  if (disclaimerAccepted) return null;

  return (
    <AnimatePresence>
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        exit={{ opacity: 0 }}
        className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4"
      >
        <motion.div
          initial={{ scale: 0.95, opacity: 0 }}
          animate={{ scale: 1, opacity: 1 }}
          className="bg-bg-secondary rounded-2xl p-6 max-w-md w-full max-h-[80vh] overflow-y-auto"
        >
          <div className="text-center mb-6">
            <div className="w-16 h-16 mx-auto mb-4 rounded-full bg-warning/20 flex items-center justify-center">
              <svg className="w-8 h-8 text-warning" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
            </div>
            <h2 className="text-xl font-bold text-text-primary">Important Notice</h2>
          </div>

          <div className="space-y-4 text-sm text-text-secondary mb-6">
            <div className="bg-bg-tertiary rounded-xl p-4">
              <h3 className="font-semibold text-text-primary mb-2">Self-Custody Wallet</h3>
              <p>ZenWallet is a self-custody wallet. You are solely responsible for your seed phrase and funds. We cannot recover your wallet if you lose your seed phrase.</p>
            </div>

            <div className="bg-bg-tertiary rounded-xl p-4">
              <h3 className="font-semibold text-text-primary mb-2">Backup Your Seed Phrase</h3>
              <p>Write down your 12-word seed phrase and store it securely offline. Never share it with anyone. Anyone with your seed phrase can access your funds.</p>
            </div>

            <div className="bg-bg-tertiary rounded-xl p-4">
              <h3 className="font-semibold text-text-primary mb-2">Irreversible Transactions</h3>
              <p>Blockchain transactions are irreversible. Always double-check addresses before sending. We cannot reverse or cancel transactions.</p>
            </div>

            <div className="bg-error/10 border border-error/20 rounded-xl p-4">
              <h3 className="font-semibold text-error mb-2">Risk Warning</h3>
              <p className="text-error/80">Cryptocurrency involves significant risk. Only invest what you can afford to lose. This is not financial advice.</p>
            </div>
          </div>

          <label className="flex items-start gap-3 mb-6 cursor-pointer">
            <input
              type="checkbox"
              checked={checked}
              onChange={(e) => setChecked(e.target.checked)}
              className="mt-1 w-5 h-5 rounded border-text-muted bg-bg-tertiary checked:bg-solana-green"
            />
            <span className="text-sm text-text-secondary">
              I understand that ZenWallet is a self-custody wallet, I am responsible for my seed phrase, and transactions are irreversible.
            </span>
          </label>

          <Button
            variant="primary"
            size="lg"
            className="w-full"
            disabled={!checked}
            onClick={acceptDisclaimer}
          >
            I Understand, Continue
          </Button>
        </motion.div>
      </motion.div>
    </AnimatePresence>
  );
}
```

**Verification:**
- On first app load, disclaimer modal should appear
- Cannot proceed without checking the checkbox
- Once accepted, should persist and not show again

---

## Batch 5.4: Error Handling

### Task 5.4.1: Create Error Boundary

**File:** `src/components/ui/ErrorBoundary.tsx`

**Code:**
```typescript
import { Component, ErrorInfo, ReactNode } from 'react';
import { Button } from './Button';

interface Props {
  children: ReactNode;
  fallback?: ReactNode;
}

interface State {
  hasError: boolean;
  error: Error | null;
}

export class ErrorBoundary extends Component<Props, State> {
  constructor(props: Props) {
    super(props);
    this.state = { hasError: false, error: null };
  }

  static getDerivedStateFromError(error: Error): State {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: ErrorInfo) {
    // Log to error reporting service in production
    if (import.meta.env.PROD) {
      console.error('Error caught by boundary:', error, errorInfo);
      // TODO: Send to error tracking service
    }
  }

  handleRetry = () => {
    this.setState({ hasError: false, error: null });
  };

  handleReload = () => {
    window.location.reload();
  };

  render() {
    if (this.state.hasError) {
      if (this.props.fallback) {
        return this.props.fallback;
      }

      return (
        <div className="min-h-screen bg-bg-primary flex items-center justify-center p-6">
          <div className="text-center max-w-md">
            <div className="w-20 h-20 mx-auto mb-6 rounded-full bg-error/20 flex items-center justify-center">
              <svg className="w-10 h-10 text-error" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
            </div>

            <h1 className="text-2xl font-bold text-text-primary mb-2">
              Something went wrong
            </h1>
            <p className="text-text-secondary mb-6">
              We encountered an unexpected error. Your funds are safe.
            </p>

            {import.meta.env.DEV && this.state.error && (
              <div className="bg-bg-secondary rounded-xl p-4 mb-6 text-left">
                <p className="text-xs text-error font-mono break-all">
                  {this.state.error.message}
                </p>
              </div>
            )}

            <div className="flex gap-3">
              <Button
                variant="secondary"
                size="lg"
                className="flex-1"
                onClick={this.handleRetry}
              >
                Try Again
              </Button>
              <Button
                variant="primary"
                size="lg"
                className="flex-1"
                onClick={this.handleReload}
              >
                Reload App
              </Button>
            </div>
          </div>
        </div>
      );
    }

    return this.props.children;
  }
}
```

**Verification:**
```typescript
// Wrap app in ErrorBoundary in main.tsx
// Intentionally throw error to test:
throw new Error('Test error');
// Should show fallback UI instead of crashing
```

---

### Task 5.4.2: Create Toast Store

**File:** `src/stores/toastStore.ts`

**Code:**
```typescript
import { create } from 'zustand';

export type ToastType = 'success' | 'error' | 'warning' | 'info';

interface Toast {
  id: string;
  type: ToastType;
  message: string;
  duration?: number;
}

interface ToastState {
  toasts: Toast[];
  addToast: (type: ToastType, message: string, duration?: number) => void;
  removeToast: (id: string) => void;
  clearAll: () => void;
}

export const useToastStore = create<ToastState>((set) => ({
  toasts: [],

  addToast: (type, message, duration = 4000) => {
    const id = `${Date.now()}-${Math.random().toString(36).slice(2)}`;

    set((state) => ({
      toasts: [...state.toasts, { id, type, message, duration }],
    }));

    // Auto remove after duration
    if (duration > 0) {
      setTimeout(() => {
        set((state) => ({
          toasts: state.toasts.filter((t) => t.id !== id),
        }));
      }, duration);
    }
  },

  removeToast: (id) => {
    set((state) => ({
      toasts: state.toasts.filter((t) => t.id !== id),
    }));
  },

  clearAll: () => {
    set({ toasts: [] });
  },
}));

// Convenience functions
export const toast = {
  success: (message: string, duration?: number) =>
    useToastStore.getState().addToast('success', message, duration),
  error: (message: string, duration?: number) =>
    useToastStore.getState().addToast('error', message, duration),
  warning: (message: string, duration?: number) =>
    useToastStore.getState().addToast('warning', message, duration),
  info: (message: string, duration?: number) =>
    useToastStore.getState().addToast('info', message, duration),
};
```

**Verification:**
```typescript
import { toast } from '@/stores/toastStore';
toast.success('Transaction sent!');
toast.error('Failed to connect');
```

---

### Task 5.4.3: Create Toast Component

**File:** `src/components/ui/Toast.tsx`

**Code:**
```typescript
import { motion, AnimatePresence } from 'framer-motion';
import { useToastStore, ToastType } from '@/stores/toastStore';

const iconMap: Record<ToastType, JSX.Element> = {
  success: (
    <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
    </svg>
  ),
  error: (
    <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
    </svg>
  ),
  warning: (
    <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
    </svg>
  ),
  info: (
    <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
  ),
};

const colorMap: Record<ToastType, string> = {
  success: 'bg-success/20 border-success/40 text-success',
  error: 'bg-error/20 border-error/40 text-error',
  warning: 'bg-warning/20 border-warning/40 text-warning',
  info: 'bg-accent-purple/20 border-accent-purple/40 text-accent-purple',
};

export function ToastContainer() {
  const { toasts, removeToast } = useToastStore();

  return (
    <div className="fixed bottom-20 left-4 right-4 z-50 flex flex-col gap-2 pointer-events-none">
      <AnimatePresence>
        {toasts.map((toast) => (
          <motion.div
            key={toast.id}
            initial={{ opacity: 0, y: 50, scale: 0.95 }}
            animate={{ opacity: 1, y: 0, scale: 1 }}
            exit={{ opacity: 0, y: -20, scale: 0.95 }}
            className={`pointer-events-auto flex items-center gap-3 p-4 rounded-xl border backdrop-blur-sm ${colorMap[toast.type]}`}
          >
            <div className="flex-shrink-0">{iconMap[toast.type]}</div>
            <p className="flex-1 text-sm font-medium">{toast.message}</p>
            <button
              onClick={() => removeToast(toast.id)}
              className="flex-shrink-0 opacity-60 hover:opacity-100 transition-opacity"
            >
              <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </motion.div>
        ))}
      </AnimatePresence>
    </div>
  );
}
```

**Verification:**
- Import ToastContainer in App.tsx
- Call toast.success/error/warning/info
- Toast should appear and auto-dismiss after 4 seconds

---

### Task 5.4.4: Create Network Status Hook and Component

**File:** `src/hooks/useNetworkStatus.ts`

**Code:**
```typescript
import { useState, useEffect } from 'react';

export function useNetworkStatus() {
  const [isOnline, setIsOnline] = useState(navigator.onLine);

  useEffect(() => {
    const handleOnline = () => setIsOnline(true);
    const handleOffline = () => setIsOnline(false);

    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);

    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, []);

  return isOnline;
}
```

**File:** `src/components/ui/NetworkStatus.tsx`

**Code:**
```typescript
import { motion, AnimatePresence } from 'framer-motion';
import { useNetworkStatus } from '@/hooks/useNetworkStatus';

export function NetworkStatus() {
  const isOnline = useNetworkStatus();

  return (
    <AnimatePresence>
      {!isOnline && (
        <motion.div
          initial={{ opacity: 0, y: -50 }}
          animate={{ opacity: 1, y: 0 }}
          exit={{ opacity: 0, y: -50 }}
          className="fixed top-0 left-0 right-0 z-50 bg-warning text-bg-primary py-2 px-4 text-center text-sm font-medium"
        >
          You're offline. Some features may be unavailable.
        </motion.div>
      )}
    </AnimatePresence>
  );
}
```

**Verification:**
- Toggle airplane mode or disconnect network
- Yellow banner should appear at top of screen
- Banner should disappear when back online

---

## Batch 5.5: Toast Integration

### Task 5.5.1: Integrate Toasts in Transaction Flows

Update `src/hooks/useTransaction.ts` to show toasts:

**Code to add after imports:**
```typescript
import { toast } from '@/stores/toastStore';
```

**Update the send function success/error handling:**
```typescript
// After successful transaction:
toast.success(`Sent ${amount} ${token.symbol} successfully!`);

// On error:
toast.error(errorMessage);
```

Similarly update `src/hooks/useSwap.ts`:
```typescript
import { toast } from '@/stores/toastStore';

// After successful swap:
toast.success('Swap completed successfully!');

// On error:
toast.error(result.error || 'Swap failed');
```

---

### Task 5.5.2: Update App.tsx with All New Components

**File:** `src/App.tsx`

**Updated Code:**
```typescript
import { Suspense, lazy } from 'react';
import { Routes, Route, useLocation, Navigate } from 'react-router-dom';
import { SolanaProvider } from './providers/SolanaProvider';
import { BottomNav } from './components/ui/BottomNav';
import { useWalletStore } from './stores/walletStore';
import { XPGainNotification, AchievementPopup } from './components/gamification';
import { ErrorBoundary } from './components/ui/ErrorBoundary';
import { ToastContainer } from './components/ui/Toast';
import { NetworkStatus } from './components/ui/NetworkStatus';
import { DisclaimerModal } from './components/modals/DisclaimerModal';
import { useSessionTimeout } from './hooks/useSessionTimeout';

// Onboarding pages (not lazy - critical path)
import WelcomePage from './pages/onboarding/index';
import CreateWalletPage from './pages/onboarding/create';
import ImportWalletPage from './pages/onboarding/import';
import ConnectWalletPage from './pages/onboarding/connect';

// Main app pages - lazy loaded
const HomePage = lazy(() => import('./pages/Home'));
const AssetsPage = lazy(() => import('./pages/Assets'));
const SwapPage = lazy(() => import('./pages/Swap'));
const AchievementsPage = lazy(() => import('./pages/Achievements'));
const SettingsPage = lazy(() => import('./pages/Settings'));

// Loading fallback
function PageLoader() {
  return (
    <div className="min-h-screen flex items-center justify-center">
      <div className="w-8 h-8 border-2 border-solana-green border-t-transparent rounded-full animate-spin" />
    </div>
  );
}

// Auth guard component
function RequireWallet({ children }: { children: React.ReactNode }) {
  const { publicKey } = useWalletStore();

  if (!publicKey) {
    return <Navigate to="/onboarding" replace />;
  }

  return <>{children}</>;
}

// Redirect if already has wallet
function OnboardingGuard({ children }: { children: React.ReactNode }) {
  const { publicKey } = useWalletStore();

  if (publicKey) {
    return <Navigate to="/" replace />;
  }

  return <>{children}</>;
}

// Session timeout wrapper
function SessionManager({ children }: { children: React.ReactNode }) {
  useSessionTimeout();
  return <>{children}</>;
}

export default function App() {
  const location = useLocation();
  const isOnboarding = location.pathname.startsWith('/onboarding');

  return (
    <ErrorBoundary>
      <SolanaProvider>
        <SessionManager>
          <div className="min-h-screen bg-bg-primary">
            {/* Global UI */}
            <NetworkStatus />
            <DisclaimerModal />
            <XPGainNotification />
            <AchievementPopup />
            <ToastContainer />

            <Suspense fallback={<PageLoader />}>
              <Routes>
                {/* Onboarding routes */}
                <Route
                  path="/onboarding"
                  element={
                    <OnboardingGuard>
                      <WelcomePage />
                    </OnboardingGuard>
                  }
                />
                <Route
                  path="/onboarding/create"
                  element={
                    <OnboardingGuard>
                      <CreateWalletPage />
                    </OnboardingGuard>
                  }
                />
                <Route
                  path="/onboarding/import"
                  element={
                    <OnboardingGuard>
                      <ImportWalletPage />
                    </OnboardingGuard>
                  }
                />
                <Route
                  path="/onboarding/connect"
                  element={
                    <OnboardingGuard>
                      <ConnectWalletPage />
                    </OnboardingGuard>
                  }
                />

                {/* Main app routes (protected) */}
                <Route
                  path="/"
                  element={
                    <RequireWallet>
                      <HomePage />
                    </RequireWallet>
                  }
                />
                <Route
                  path="/assets"
                  element={
                    <RequireWallet>
                      <AssetsPage />
                    </RequireWallet>
                  }
                />
                <Route
                  path="/swap"
                  element={
                    <RequireWallet>
                      <SwapPage />
                    </RequireWallet>
                  }
                />
                <Route
                  path="/achievements"
                  element={
                    <RequireWallet>
                      <AchievementsPage />
                    </RequireWallet>
                  }
                />
                <Route
                  path="/settings"
                  element={
                    <RequireWallet>
                      <SettingsPage />
                    </RequireWallet>
                  }
                />

                {/* Fallback */}
                <Route path="*" element={<Navigate to="/" replace />} />
              </Routes>
            </Suspense>

            {/* Bottom navigation (only on main app) */}
            {!isOnboarding && <BottomNav />}
          </div>
        </SessionManager>
      </SolanaProvider>
    </ErrorBoundary>
  );
}
```

**Verification:**
```bash
npm run build
npm run preview
# Test all features still work
# Check code splitting in network tab
```

---

## Batch 5.6: UX Polish

### Task 5.6.1: Create Skeleton Components

**File:** `src/components/ui/Skeleton.tsx`

**Code:**
```typescript
import { motion } from 'framer-motion';

interface SkeletonProps {
  className?: string;
  variant?: 'text' | 'circular' | 'rectangular';
  width?: string | number;
  height?: string | number;
}

export function Skeleton({
  className = '',
  variant = 'rectangular',
  width,
  height,
}: SkeletonProps) {
  const baseClasses = 'bg-bg-tertiary animate-pulse';

  const variantClasses = {
    text: 'rounded',
    circular: 'rounded-full',
    rectangular: 'rounded-xl',
  };

  const style = {
    width: width || (variant === 'text' ? '100%' : undefined),
    height: height || (variant === 'text' ? '1em' : undefined),
  };

  return (
    <motion.div
      initial={{ opacity: 0.5 }}
      animate={{ opacity: [0.5, 0.8, 0.5] }}
      transition={{ duration: 1.5, repeat: Infinity }}
      className={`${baseClasses} ${variantClasses[variant]} ${className}`}
      style={style}
    />
  );
}

// Pre-built skeleton layouts
export function TokenRowSkeleton() {
  return (
    <div className="flex items-center justify-between p-4 bg-bg-secondary rounded-xl">
      <div className="flex items-center gap-3">
        <Skeleton variant="circular" width={40} height={40} />
        <div className="space-y-2">
          <Skeleton variant="text" width={60} height={16} />
          <Skeleton variant="text" width={100} height={12} />
        </div>
      </div>
      <div className="text-right space-y-2">
        <Skeleton variant="text" width={80} height={16} />
        <Skeleton variant="text" width={60} height={12} />
      </div>
    </div>
  );
}

export function BalanceCardSkeleton() {
  return (
    <div className="bg-gradient-to-br from-bg-secondary to-bg-tertiary rounded-2xl p-6">
      <div className="text-center mb-6">
        <Skeleton variant="text" width={100} height={14} className="mx-auto mb-2" />
        <Skeleton variant="text" width={200} height={48} className="mx-auto" />
      </div>
      <div className="grid grid-cols-3 gap-3">
        {[1, 2, 3].map((i) => (
          <Skeleton key={i} variant="rectangular" height={60} />
        ))}
      </div>
    </div>
  );
}
```

**Verification:**
- Use `<TokenRowSkeleton />` in TokenList when loading
- Use `<BalanceCardSkeleton />` in Home when loading

---

### Task 5.6.2: Create Empty State Component

**File:** `src/components/ui/EmptyState.tsx`

**Code:**
```typescript
import { motion } from 'framer-motion';
import { Button } from './Button';

interface EmptyStateProps {
  icon?: JSX.Element;
  title: string;
  description?: string;
  action?: {
    label: string;
    onClick: () => void;
  };
}

export function EmptyState({ icon, title, description, action }: EmptyStateProps) {
  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      className="text-center py-12 px-4"
    >
      {icon && (
        <div className="w-16 h-16 mx-auto mb-4 rounded-full bg-bg-tertiary flex items-center justify-center text-text-muted">
          {icon}
        </div>
      )}
      <h3 className="text-lg font-semibold text-text-primary mb-2">{title}</h3>
      {description && (
        <p className="text-text-muted text-sm mb-6 max-w-xs mx-auto">{description}</p>
      )}
      {action && (
        <Button variant="primary" size="md" onClick={action.onClick}>
          {action.label}
        </Button>
      )}
    </motion.div>
  );
}

// Pre-built empty states
export function NoTokensState({ onReceive }: { onReceive: () => void }) {
  return (
    <EmptyState
      icon={
        <svg className="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      }
      title="No tokens yet"
      description="Add SOL or other tokens to your wallet to get started"
      action={{ label: 'Receive', onClick: onReceive }}
    />
  );
}

export function NoTransactionsState() {
  return (
    <EmptyState
      icon={
        <svg className="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
        </svg>
      }
      title="No transactions yet"
      description="Your transaction history will appear here"
    />
  );
}
```

**Verification:**
- Use empty states in TokenList, transaction lists
- Should show helpful message instead of blank space

---

### Task 5.6.3: Create Secure Clipboard Hook

**File:** `src/hooks/useClipboard.ts`

**Code:**
```typescript
import { useState, useCallback, useRef } from 'react';
import { toast } from '@/stores/toastStore';

const AUTO_CLEAR_TIMEOUT = 60000; // 60 seconds

export function useClipboard() {
  const [copied, setCopied] = useState(false);
  const timeoutRef = useRef<NodeJS.Timeout | null>(null);

  const copy = useCallback(async (text: string, message?: string) => {
    try {
      await navigator.clipboard.writeText(text);
      setCopied(true);

      // Show toast
      toast.success(message || 'Copied to clipboard');

      // Auto-clear copied state after 2 seconds (UI feedback)
      setTimeout(() => setCopied(false), 2000);

      // Clear clipboard after 60 seconds (security)
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current);
      }

      timeoutRef.current = setTimeout(async () => {
        try {
          // Only clear if clipboard still contains our text
          const current = await navigator.clipboard.readText();
          if (current === text) {
            await navigator.clipboard.writeText('');
            toast.info('Clipboard cleared for security');
          }
        } catch {
          // Clipboard access denied, ignore
        }
      }, AUTO_CLEAR_TIMEOUT);

      return true;
    } catch (error) {
      toast.error('Failed to copy');
      return false;
    }
  }, []);

  return { copied, copy };
}
```

**Verification:**
- Use in ReceiveModal instead of direct clipboard.writeText
- Should show toast and auto-clear after 60 seconds

---

## Batch 5.7: Build Optimization

### Task 5.7.1: Verify Build Output

**Command:**
```bash
cd /Users/lucasbertol/zenwallet && npm run build
```

**Expected Output:**
- Multiple chunks (solana, wallet-adapter, jupiter, ui)
- Each chunk < 500KB
- Total gzipped size < 400KB

---

### Task 5.7.2: Add Production Optimizations to main.tsx

**File:** `src/main.tsx`

**Code:**
```typescript
import React from 'react';
import ReactDOM from 'react-dom/client';
import { BrowserRouter } from 'react-router-dom';
import App from './App';
import './index.css';

// Remove console logs in production
if (import.meta.env.PROD) {
  console.log = () => {};
  console.debug = () => {};
  console.info = () => {};
  // Keep console.warn and console.error for debugging
}

// Register service worker
if ('serviceWorker' in navigator && import.meta.env.PROD) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js').catch((error) => {
      console.error('SW registration failed:', error);
    });
  });
}

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <BrowserRouter>
      <App />
    </BrowserRouter>
  </React.StrictMode>
);
```

**Verification:**
```bash
npm run build && npm run preview
# Console logs should not appear in production
```

---

## Batch 5.8: Testing Setup

### Task 5.8.1: Install Test Dependencies

**Command:**
```bash
cd /Users/lucasbertol/zenwallet && npm install -D vitest @testing-library/react @testing-library/jest-dom jsdom @vitest/ui
```

---

### Task 5.8.2: Create Vitest Config

**File:** `vitest.config.ts`

**Code:**
```typescript
import { defineConfig } from 'vitest/config';
import react from '@vitejs/plugin-react';
import path from 'path';

export default defineConfig({
  plugins: [react()],
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: './tests/setup.ts',
    include: ['tests/**/*.test.ts', 'tests/**/*.test.tsx'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: ['node_modules/', 'tests/'],
    },
  },
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
});
```

**File:** `tests/setup.ts`

**Code:**
```typescript
import '@testing-library/jest-dom';
import { vi } from 'vitest';

// Mock crypto for Node environment
Object.defineProperty(globalThis, 'crypto', {
  value: {
    getRandomValues: (arr: Uint8Array) => {
      for (let i = 0; i < arr.length; i++) {
        arr[i] = Math.floor(Math.random() * 256);
      }
      return arr;
    },
    subtle: {
      importKey: vi.fn(),
      deriveKey: vi.fn(),
      encrypt: vi.fn(),
      decrypt: vi.fn(),
    },
  },
});

// Mock localStorage
const localStorageMock = {
  getItem: vi.fn(),
  setItem: vi.fn(),
  removeItem: vi.fn(),
  clear: vi.fn(),
};
Object.defineProperty(window, 'localStorage', { value: localStorageMock });

// Mock IndexedDB
const indexedDBMock = {
  open: vi.fn(),
};
Object.defineProperty(window, 'indexedDB', { value: indexedDBMock });
```

**Update package.json scripts:**
```json
{
  "scripts": {
    "test": "vitest",
    "test:ui": "vitest --ui",
    "test:coverage": "vitest --coverage"
  }
}
```

---

### Task 5.8.3: Create Critical Unit Tests

**File:** `tests/gamification/xp.test.ts`

**Code:**
```typescript
import { describe, it, expect } from 'vitest';
import { XP_VALUES, LEVELS } from '@/types/gamification';

describe('XP System', () => {
  describe('XP Values', () => {
    it('should have positive XP values for all actions', () => {
      Object.values(XP_VALUES).forEach((value) => {
        expect(value).toBeGreaterThan(0);
      });
    });

    it('should reward daily login', () => {
      expect(XP_VALUES.daily_login).toBeDefined();
      expect(XP_VALUES.daily_login).toBeGreaterThanOrEqual(10);
    });

    it('should reward transactions more than daily login', () => {
      expect(XP_VALUES.send).toBeGreaterThan(XP_VALUES.daily_login);
    });
  });

  describe('Level System', () => {
    it('should have increasing XP thresholds', () => {
      for (let i = 1; i < LEVELS.length; i++) {
        expect(LEVELS[i].minXP).toBeGreaterThan(LEVELS[i - 1].minXP);
      }
    });

    it('should start at level 1 with 0 XP', () => {
      expect(LEVELS[0].number).toBe(1);
      expect(LEVELS[0].minXP).toBe(0);
    });

    it('should have unique level names', () => {
      const names = LEVELS.map((l) => l.name);
      const uniqueNames = new Set(names);
      expect(uniqueNames.size).toBe(names.length);
    });
  });
});
```

**File:** `tests/security/rateLimiter.test.ts`

**Code:**
```typescript
import { describe, it, expect, beforeEach, vi } from 'vitest';
import {
  isLocked,
  recordFailedAttempt,
  resetAttempts,
  formatLockoutTime,
} from '@/lib/security/rateLimiter';

describe('Rate Limiter', () => {
  beforeEach(() => {
    resetAttempts();
    vi.useFakeTimers();
  });

  it('should not be locked initially', () => {
    expect(isLocked().locked).toBe(false);
  });

  it('should allow 5 attempts before locking', () => {
    for (let i = 0; i < 4; i++) {
      const result = recordFailedAttempt();
      expect(result.locked).toBe(false);
      expect(result.attemptsRemaining).toBe(4 - i);
    }

    const finalResult = recordFailedAttempt();
    expect(finalResult.locked).toBe(true);
    expect(finalResult.attemptsRemaining).toBe(0);
  });

  it('should reset attempts after successful unlock', () => {
    for (let i = 0; i < 3; i++) {
      recordFailedAttempt();
    }

    resetAttempts();

    const status = isLocked();
    expect(status.locked).toBe(false);
  });

  it('should format lockout time correctly', () => {
    expect(formatLockoutTime(60000)).toBe('1 minute');
    expect(formatLockoutTime(120000)).toBe('2 minutes');
    expect(formatLockoutTime(3600000)).toBe('1h 0m');
  });
});
```

**Verification:**
```bash
npm run test
# All tests should pass
```

---

## Code Review Checkpoint: MVP 1.2.0 Complete

### Final Verification Checklist

```bash
cd /Users/lucasbertol/zenwallet

# 1. Install all dependencies
npm install

# 2. Run tests
npm run test

# 3. Build for production
npm run build

# 4. Preview production build
npm run preview
```

### Manual Testing Checklist

| Feature | Test | Expected |
|---------|------|----------|
| **PWA** | Open on mobile, check "Add to Home Screen" | Install prompt appears |
| **Offline** | Disconnect network, navigate app | Cached pages work, offline banner shows |
| **Rate Limiting** | Enter wrong PIN 5 times | Lockout message with countdown |
| **Session Timeout** | Wait 5 minutes idle | Auto-lock, redirect to unlock screen |
| **Disclaimers** | Clear localStorage, reload | Disclaimer modal appears |
| **Error Boundary** | Force an error | Error fallback UI shows |
| **Toasts** | Send transaction | Success toast appears |
| **Network Status** | Toggle airplane mode | Yellow banner appears |
| **Code Splitting** | Check network tab | Multiple JS chunks loaded |

---

## Files Summary

### New Files (15)
1. `src/lib/security/rateLimiter.ts`
2. `src/stores/securityStore.ts`
3. `src/stores/toastStore.ts`
4. `src/hooks/useSessionTimeout.ts`
5. `src/hooks/useNetworkStatus.ts`
6. `src/hooks/useClipboard.ts`
7. `src/hooks/usePWAInstall.ts`
8. `src/components/ui/ErrorBoundary.tsx`
9. `src/components/ui/Toast.tsx`
10. `src/components/ui/NetworkStatus.tsx`
11. `src/components/ui/Skeleton.tsx`
12. `src/components/ui/EmptyState.tsx`
13. `src/components/modals/DisclaimerModal.tsx`
14. `vitest.config.ts`
15. `tests/setup.ts`, `tests/**/*.test.ts`

### Updated Files (5)
1. `vite.config.ts` - PWA plugin + code splitting
2. `src/main.tsx` - Console suppression + SW registration
3. `src/App.tsx` - Error boundary, session timeout, lazy loading
4. `src/stores/walletStore.ts` - Rate limiting
5. `src/hooks/useTransaction.ts` + `useSwap.ts` - Toast integration

---

## Production Readiness Score After MVP 1.2.0

| Category | Before | After |
|----------|--------|-------|
| Core Wallet | 95% | 95% |
| Gamification | 90% | 90% |
| Security | 60% | 90% |
| PWA/Offline | 0% | 85% |
| Error Handling | 55% | 90% |
| Testing | 0% | 60% |
| **Overall** | **~55%** | **~90%** |

---

## Recommended Agents for Execution

| Task Type | Agent |
|-----------|-------|
| Frontend components | `frontend-engineer` |
| Security features | `security-reviewer` (review after) |
| Testing | `qa-analyst` |
| Build config | `devops-engineer` |
| Fallback | `general-purpose` |

---

## Changelog

| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | 2025-12-26 | Initial MVP 1.2.0 Production Ready plan |
